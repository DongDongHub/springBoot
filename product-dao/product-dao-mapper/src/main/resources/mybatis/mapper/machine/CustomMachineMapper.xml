<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.mazekkkk.product.dao.mapper.machine.CustomMachineMapper">

    <resultMap id="machineRfidShelveRecord" type="cn.mazekkkk.product.dao.common.MachineRfidShelveRecord" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Feb 19 15:21:50 CST 2016.
        -->
        <id column="id" property="id" jdbcType="OTHER" />
        <result column="machine_id" property="machineId" jdbcType="OTHER" />
        <result column="tid" property="tid" jdbcType="OTHER" />
        <result column="user_id" property="userId" jdbcType="OTHER" />
        <result column="sku_id" property="skuId" jdbcType="OTHER" />
        <result column="add_time" property="addTime" jdbcType="OTHER" />
        <result column="shelve_id" property="shelveId" jdbcType="OTHER" />
        <result column="mcr_id" property="mcrId" jdbcType="OTHER" />
    </resultMap>

    <select id="getMachineSaleProducts" resultType="java.util.Map">
        SELECT si.id, si.name,mcr.name mcr_name
        ,<![CDATA[ CASE WHEN mcr.status != 1 OR ADDDATE(msr.shelve_time,INTERVAL msr.storage_time HOUR) < NOW()
        THEN 0 ELSE mis.sku_qty END AS sku_qty ]]>
        ,msr.id msr_id,CONCAT(cis.img_server,cis.img_path) as img_url,mis.u_version,mcr.id mcr_id,
        mcr.appid,si.pc_id,si.kit as sku_kit
        FROM machine_road_info mcr
        LEFT JOIN machine_road_inventory mis ON mcr.id = mis.mcr_id
        LEFT JOIN sku_info si ON mis.sku_id = si.id AND si.status = 1
        LEFT JOIN machine_shelve_record msr ON mcr.id = msr.mcr_id AND si.id = msr.sku_id AND msr.status = 1
        LEFT JOIN common_imgs cis ON si.id = cis.object_id AND cis.object_type = 1 AND cis.img_type =
        #{imgType,jdbcType=VARCHAR}
        WHERE mcr.machine_id = #{machineId,jdbcType=VARCHAR}
        ORDER BY mcr.mcr_row ASC,mcr.mcr_column ASC;
    </select>

    <select id="getKitComponents" resultType="java.util.Map">
        SELECT skd.sku_weight,skd.sku_qty,si.description,cad.community,cad.street,si.name as prodname,
        skd.weight_unit,pv.name as vname,CONCAT(cim.img_server,cim.img_path) as img_url
        FROM sku_kit_detail skd
        LEFT JOIN sku_info si ON skd.kit_id = si.id AND si.status = 1
        LEFT JOIN product_vender pv ON si.vender_id = pv.id AND pv.status = 1
        LEFT JOIN common_address cad ON si.area_id = cad.id
        LEFT JOIN common_imgs cim ON skd.child_id = cim.object_id AND cim.object_type = 1 AND cim.img_type =
        #{imgType,jdbcType=VARCHAR}
        WHERE skd.kit_id = #{skuId,jdbcType=VARCHAR}
        AND skd.status = 1
    </select>

    <select id="getMachineProByProductId" resultType="java.util.Map">
        SELECT si.name,si.description,CONCAT(cis.img_server,cis.img_path) as img_url
        FROM sku_info si
        LEFT JOIN common_imgs cis ON cis.object_id = si.id AND cis.object_type = 1 AND cis.img_type =
        #{imgType,jdbcType=VARCHAR}
        WHERE si.id = #{skuId,jdbcType=VARCHAR}
    </select>

    <insert id="insertRfidShelveRecord" parameterType="java.util.List">
        insert into machine_rfid_shelve_record ( machine_id, tid, user_id, sku_id,mcr_id,shelve_id) values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.machineId,jdbcType=BIGINT}, #{item.tid,jdbcType=VARCHAR},
            #{item.userId,jdbcType=BIGINT}, #{item.skuId,jdbcType=BIGINT},
            #{item.mcrId,jdbcType=BIGINT},#{item.shelveId,jdbcType=BIGINT})
        </foreach>
    </insert>


    <insert id="insertRfidLossRecord" parameterType="java.util.List">
        insert into machine_rfid_loss_record ( machine_id, tid, user_id, sku_id,mcr_id,loss_id) values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.machineId,jdbcType=BIGINT}, #{item.tid,jdbcType=VARCHAR},
            #{item.userId,jdbcType=BIGINT}, #{item.skuId,jdbcType=BIGINT},
            #{item.mcrId,jdbcType=BIGINT},#{item.lossId,jdbcType=BIGINT})
        </foreach>
    </insert>

    <select id="getNowInventory" parameterType="java.lang.Long" resultMap="machineRfidShelveRecord">
        select mrsr.id,mrsr.tid,mrsr.machine_id,mrsr.user_id,mrsr.sku_id,mrsr.add_time,mrsr.shelve_id,mrsr.mcr_id
        from machine_rfid_shelve_record mrsr
        where not exists (
        select 1
        from machine_sale_record msr
        where mrsr.tid = msr.tid
        )
        and mrsr.shelve_id = #{shelveId,jdbcType=VARCHAR}
    </select>
</mapper>